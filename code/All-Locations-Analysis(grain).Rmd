---
title: "All-Locations-Analysis(grain)"
author: "lkt38"
date: "2024-09-21"
output: html_document
editor_options:
  chunk_output_type: console
output_dir: "/Users/leahtreffer/GitHub/OatPea_intercrop/docs"
---

# the only thing all locations have in common is grain yield. So will compare locations by the intercrop oat, pea, and total grain yield

```{r, echo=FALSE}
knitr::opts_knit$set(root.dir = "/Users/leahtreffer/GitHub/OatPea_intercrop", echo = TRUE, warning = FALSE, message = FALSE)
```

```{r eval=FALSE}
setwd("/Users/leahtreffer/GitHub/OatPea_intercrop")
```

## load libraries
```{r,  echo=FALSE}
library(RColorBrewer)
library(tidyverse)
library(dplyr)
library(readxl)
library(kableExtra)
library(ggrepel)
library(ggplot2)
library(ggfortify)  # For autoplot function for PCA
library(lme4)
library(emmeans)
library(performance)
library(corrplot)
library(emmeans)
library(broom.mixed)
library(knitr)
```

## load in and manipulate data files
```{r,  include=FALSE, warning=FALSE}
multi_location_data <- read.csv("data/2023_2024_multi_location.csv")

multi_location_data <- multi_location_data%>%
  mutate(total_grain = oat_yield + pea_yield)
```

## chage data type (character,factor,numeric)
```{r}
#colnames(multi_location_data)
multi_location_data$studyName <- as.character(multi_location_data$studyName)
multi_location_data$studyYear <- as.factor(multi_location_data$studyYear)
multi_location_data$studyLoc <- as.factor(multi_location_data$studyLoc)
multi_location_data$replicate <- as.factor(multi_location_data$replicate)
#multi_location_data$rowNumber <- as.factor(multi_location_data$rowNumber)
multi_location_data$plotNumber <- as.character(multi_location_data$plotNumber)
multi_location_data$germplasmName <- as.character(multi_location_data$germplasmName)
multi_location_data$peaName <- as.character(multi_location_data$peaName)
multi_location_data$pea_type <- as.character(multi_location_data$pea_type)
multi_location_data$observationLevel <- as.character(multi_location_data$observationLevel)
multi_location_data$observationUnitName <- as.character(multi_location_data$observationUnitName)
multi_location_data$oat_yield <- as.numeric(multi_location_data$oat_yield)
multi_location_data$pea_yield <- as.numeric(multi_location_data$pea_yield)
multi_location_data$total_grain <- as.numeric(multi_location_data$total_grain)
multi_location_data$oat_fraction <- as.numeric(multi_location_data$oat_fraction)
```

## Yield Histogram for all locations
```{r}
custom_colors <- c(
  "2023.IL" = "#35B7AD",  # Dark Red for Illinois 2023
  "2024.IL" = "#B0E8E5",  # Light Red for Illinois 2024
  "2023.NY" = "#1F28A2",  # Medium Blue for New York 2023
  "2024.NY" = "#9D9ED4",  # Sky Blue for New York 2024
  "2023.SD" = "#AE6C13",  # Dark Orange for South Dakota 2023
  "2024.SD" = "#E4B98F",  # Gold for South Dakota 2024
  "2023.WI" = "#7D0112"#,  # Dark Purple for Wisconsin 2023
  #"Wisconsin_2024" = "#A24C5D"   # Orchid for Wisconsin 2024
)

ggplot(multi_location_data, aes(x = oat_yield)) +
  geom_histogram(aes(y = ..density..), color = "black", fill = "gray", bins = 30, alpha = 0.5) +
  geom_density(aes(color = interaction(studyYear, studyLoc)), size = 1) +
  scale_color_manual(values = custom_colors) +
  labs(
    #title = "Distribution with Density Lines by Year and Location",
    x = "Value",
    y = "Density",
    color = "Year & Location"
  ) +
  theme_minimal()


ggplot(multi_location_data, aes(x = log(pea_yield+0.1))) +
  geom_histogram(aes(y = ..density..), color = "black", fill = "gray", bins = 30, alpha = 0.5) +
  geom_density(aes(color = interaction(studyYear, studyLoc)), size = 1) +
  scale_color_manual(values = custom_colors) +
  labs(
    #title = "Distribution with Density Lines by Year and Location",
    x = "Value",
    y = "Density",
    color = "Year & Location"
  ) +
  theme_minimal()

rm(custom_colors)


```

## Grain Yield Box Plot
```{r,  echo=FALSE, warning=FALSE}

# can try grain yield and log grain yeild by changing following lines:
  # ggplot(aes(grain_type, grain_g)) +
  # geom_jitter(aes(grain_type, grain_g, color = pea_type), 

multi_location_data %>%
  pivot_longer(oat_yield:pea_yield,
               names_to = "grain_type", values_to = "grain_g") %>%
  mutate(grain_type = str_replace(grain_type, "_yield", "")) %>%
  mutate(log_grain_g = log(grain_g)) %>%
  
  # Create a new column that combines location and year
  mutate(location_year = paste(location, studyYear, sep = "_")) %>%
  
  ggplot(aes(grain_type, grain_g)) +
  geom_boxplot() +
  geom_jitter(aes(grain_type, grain_g, color = grain_type), 
              width = 0.25, size = 4, alpha = 0.75) +
  
  xlab("") +
  ylab("Grain Yield (g/m2)") +
  scale_color_manual(values = hcl.colors(2, palette = "Fall")) +
  #scale_color_brewer(palette = "Dark2") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) +
  theme(axis.text = element_text(size = 24), axis.title = element_text(size = 24, face = "bold")) +
  theme(axis.text.x = element_text(face = "bold", color = "black", size = 20)) +
  theme(axis.text.y = element_text(face = "bold", color = "black", size = 20)) +
  
  theme(strip.text = element_text(size = 20, face = "plain"),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 22, face = "plain")) +   # Adjust the subtitles and ledgend font size
  
  # Facet by both location and year
  facet_wrap(~location_year, nrow = 3, ncol = 2)
# saved as analysis/figures/Grain_Yield_oatpea 1200x1323
```

```{r}
library(lmerTest)
library(flextable)
library(multcomp)
custom_letters <- c("a", "b", "c", "d", "e", "f", "g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z")

df_long <- multi_location_data %>%
  pivot_longer(
    cols = c(oat_yield, pea_yield),  # columns to combine
    names_to = "species",            # new column for original column names
    values_to = "grain_yield"        # new column for the values
  ) %>%
  mutate(species = sub("_yield", "", species))  # clean species names

# significant difference by location, year, grain type
model <- lmer(grain_yield ~ studyYear*studyLoc*species +(1|replicate), data=df_long)
aov.table <- anova(model)
table = flextable(data = aov.table %>%
                    mutate(`Pr(>F)` = formatC(`Pr(>F)`, format = "e", digits = 2))%>% 
                    dplyr::select(`NumDF`, `Pr(>F)`) %>%
                    rownames_to_column(" "))
bold(table, bold = TRUE, part = "header")
emm <- emmeans(model, list(pairwise ~ species|studyYear*studyLoc), adjust = "tukey") # significant differences among species groups within each Year × Location
emm <- emmeans(model, list(pairwise ~ studyLoc|studyYear*species), adjust = "tukey") # significant differences among locations within each species × Year
emm <- emmeans(model, list(pairwise ~ studyYear|studyLoc*species), adjust = "tukey") # significant differences among years within each species × Location

# Three-way estimated means
emm <- emmeans(model, ~ species*studyYear*studyLoc)
# Tukey pairwise comparisons across ALL groups

cld <- cld(emm, Letters = letters, adjust = "tukey")
rownames(cld) <- NULL
cld<- cld %>%
  dplyr::select(species, studyYear, studyLoc, emmean, .group)
```

## PCA
```{r}
pca_multi_location_data <- multi_location_data

custom_colors2 <- c(
  "IL" = "#35B7AD",  # Dark Red for Illinois 2023
  "NY" = "#1F28A2",  # Medium Blue for New York 2023
  "SD" = "#AE6C13",  # Dark Orange for South Dakota 2023
  "WI" = "#7D0112"  # Dark Purple for Wisconsin 2023
)

# Run PCA using multiple variables (oat_yield, pea_yield, total_yield)
pca_result <- prcomp(pca_multi_location_data[, c("oat_yield", "pea_yield", "total_grain")], center = TRUE, scale. = TRUE)

pca_multi_location_data$pca1 <- pca_result$x[, 1]  # First principal component
pca_multi_location_data$pca2 <- pca_result$x[, 2]  # Second principal component (if needed)

# PCA plot with custom colors and shapes by year
ggplot(pca_multi_location_data, aes(x = pca1, y = pca2, color = interaction(studyLoc), shape = studyYear)) +
  geom_point(size = 3) +
  scale_color_manual(values = custom_colors2) +  # Custom colors for locations and years
  labs(title = "PCA of Oat, Pea, and Total Yields by Location and Year",
       x = "Principal Component 1",
       y = "Principal Component 2",
       color = "Location",
       shape = "Year") +
  theme_minimal() +
  theme(legend.position = "right")

rm(pca2, pca1, pca_multi_location_data, pca_result, custom_colors2)
```

## Grain Correlations
```{r}
corr_grain = cor(multi_location_data[,c("oat_yield", "pea_yield", "total_grain")], use="pairwise.complete.obs", method="pearson")

corrplot.mixed(
  corr_grain,
  lower = "circle",
  upper = "number",
  lower.col = NA,       # Make lower part blank if needed
  tl.cex = 0.6          # Adjust this value to decrease font size of trait labels
)


corr_IL23 = cor(Illinois23[,c("oat_yield", "pea_yield", "total_grain")], use="pairwise.complete.obs", method="pearson")

corrplot.mixed(
  corr_IL23,
  lower = "circle",
  upper = "number",
  lower.col = NA,       # Make lower part blank if needed
  tl.cex = 0.6          # Adjust this value to decrease font size of trait labels
)

corr_IL24 = cor(Illinois24[,c("oat_yield", "pea_yield", "total_grain")], use="pairwise.complete.obs", method="pearson")

corrplot.mixed(
  corr_IL24,
  lower = "circle",
  upper = "number",
  lower.col = NA,       # Make lower part blank if needed
  tl.cex = 0.6          # Adjust this value to decrease font size of trait labels
)


corr_NY23 = cor(NewYork23[,c("oat_yield", "pea_yield", "total_grain")], use="pairwise.complete.obs", method="pearson")

corrplot.mixed(
  corr_NY23,
  lower = "circle",
  upper = "number",
  lower.col = NA,       # Make lower part blank if needed
  tl.cex = 0.6          # Adjust this value to decrease font size of trait labels
)

corr_NY24 = cor(NewYork24[,c("oat_yield", "pea_yield", "total_grain")], use="pairwise.complete.obs", method="pearson")

corrplot.mixed(
  corr_NY24,
  lower = "circle",
  upper = "number",
  lower.col = NA,       # Make lower part blank if needed
  tl.cex = 0.6          # Adjust this value to decrease font size of trait labels
)

corr_SD23 = cor(SDSU23[,c("oat_yield", "pea_yield", "total_grain")], use="pairwise.complete.obs", method="pearson")

corrplot.mixed(
  corr_SD23,
  lower = "circle",
  upper = "number",
  lower.col = NA,       # Make lower part blank if needed
  tl.cex = 0.6          # Adjust this value to decrease font size of trait labels
)

corr_SD24 = cor(SDSU24[,c("oat_yield", "pea_yield", "total_grain")], use="pairwise.complete.obs", method="pearson")

corrplot.mixed(
  corr_SD24,
  lower = "circle",
  upper = "number",
  lower.col = NA,       # Make lower part blank if needed
  tl.cex = 0.6          # Adjust this value to decrease font size of trait labels
)

corr_WI23 = cor(Wisconsin23[,c("oat_yield", "pea_yield", "total_grain")], use="pairwise.complete.obs", method="pearson")

corrplot.mixed(
  corr_WI23,
  lower = "circle",
  upper = "number",
  lower.col = NA,       # Make lower part blank if needed
  tl.cex = 0.6          # Adjust this value to decrease font size of trait labels
)

rm(corr_grain, corr_IL23, corr_IL24, corr_NY, corr_NY23, corr_NY24, corr_SD23, corr_SD24, corr_WI23)

```

```{r}
rm(Illinois, Illinois23, Illinois24, meta2023, NewYork, NewYork23, NewYork23pt1, NewYork24, SDSU23, SDSU24, SouthDakota, Wisconsin23)
```

## mixed linear model
```{r}
model <- lmer(oat_yield ~ germplasmName + peaName + pea_type + management + pea_yield + studyLoc + (1 | studyLoc/observationUnitName), data = multi_location_data)

# Overall ANOVA
anova(model)

# Pairwise comparisons
pairwise_comparisons <- emmeans(model, pairwise ~ location)
summary(pairwise_comparisons)

```

## model assumptions
```{r}
#model assumptions

# Plot residuals vs fitted values to check for homogeneity of variance
plot(fitted(model), resid(model),
     main = "Residuals vs Fitted",
     xlab = "Fitted values",
     ylab = "Residuals")
abline(h = 0, col = "red")

# Check for normality of residuals with a Q-Q plot
qqnorm(resid(model), main = "Q-Q Plot of Residuals")
qqline(resid(model), col = "red")

# Alternatively, use performance::check_model for a comprehensive diagnostic check
check_model(model)
```

## spatial correction for mixed linear model
## Oat Yield
```{r}
# multi-location mixed-effects model with spatial correction
# Since spatial variation may differ between locations, include location as a random effect in the model

model1 <- lmer(oat_yield ~ germplasmName + peaName + pea_yield + (1 | studyLoc), data = multi_location_data)
model2 <- lmer(oat_yield ~ germplasmName + peaName + (1 | studyLoc), data = multi_location_data)
model3 <- lmer(oat_yield ~ germplasmName + peaName + pea_yield + (1 | studyLoc/blockNumber), data = multi_location_data)
model4 <- lmer(oat_yield ~ germplasmName + peaName + (1 | studyLoc/blockNumber), data = multi_location_data)
model5 <- lmer(oat_yield ~ germplasmName * peaName + (1 | studyLoc), data = multi_location_data)


# Compare models with anova to see both AIC and model fit statistics
#anova(model1, model2, model3, model4)
aic_values <- AIC(model1, model2, model3, model4, model5, model6)
print(aic_values)

# best AIC was model5

model_oat <- lmerTest::lmer(oat_yield ~ germplasmName * peaName + (1 | studyLoc), data = multi_location_data)

# Perform Type III ANOVA to test the significance of each term as a group
# significance tests for each fixed effect in your model after accounting for all other effects
anova_results <- anova(model_oat, type = 3)
anova_results
# Sum Sq (Sum of Squares): represents the amount of variance in the response variable that is explained by each predictor or interaction term in the model.Higher sums of squares indicate a larger contribution of that factor to explaining variability in the response variable.
# Mean Sq (Mean Square): sum of squares divided by the degrees of freedom for each effect.Used to calculate the F-value and indicates how much of the variance can be attributed to that effect on average.
# F-value: ratio of the mean square of the effect to the mean square of the error (residuals). A higher F-value indicates a more significant effect, suggesting that the variance explained by this effect is large relative to the residual variance.
# Pr(>F): p-value associated with the F-test for each effect. A small p-value (typically < 0.05) suggests that the effect is statistically significant, meaning it has a significant impact on the response variable after accounting for all other effects.


# Create a table of significant results
significant_summary <- broom.mixed::tidy(model_oat, effects = "fixed") %>%
  filter(p.value < 0.05)

significant_summary %>%
  select(term, estimate, std.error, statistic, p.value) %>%
  mutate(p.value = format(p.value, scientific = TRUE)) %>%
  kable(digits = 3, caption = "Significant Covariates in Linear Mixed Model for Oat Yield",
        col.names = c("Term", "Estimate", "Std. Error", "t value", "P value")) %>%
  kable_styling(full_width = FALSE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))


anova_results %>%
  select(`Sum Sq`, `Mean Sq`, NumDF, `F value`, `Pr(>F)`) %>%
  kable(digits = 5, caption = "Significant Covariates in Linear Mixed Model for Oat Yield",
        col.names = c("Sum Sq", "Mean Sq", "NumDF", "F value", "Pr(>F)")) %>%
  kable_styling(full_width = FALSE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))



# Likelihood Ratio test to determine significance of random effect (location)
# Compare the full and reduced models 

model_reduced <- lm(oat_yield ~ germplasmName * peaName, data = multi_location_data)

# Likelihood ratio test
anova(model_reduced, model_oat)

rm(model1, model2, model3, model4, model5, significant_summary, aic_values, anova_results, full_model)
```

## Pea Yield
```{r}
# multi-location mixed-effects model with spatial correction
# Since spatial variation may differ between locations, include location as a random effect in the model

model1 <- lmer(pea_yield ~ germplasmName + peaName + oat_yield + (1 | studyLoc), data = multi_location_data)
model2 <- lmer(pea_yield ~ germplasmName + peaName + (1 | studyLoc), data = multi_location_data)
model3 <- lmer(pea_yield ~ germplasmName + peaName + oat_yield + (1 | studyLoc/blockNumber), data = multi_location_data)
model4 <- lmer(pea_yield ~ germplasmName + peaName + (1 | studyLoc/blockNumber), data = multi_location_data)
model5 <- lmer(pea_yield ~ germplasmName * peaName + (1 | studyLoc), data = multi_location_data)


# Compare models with anova to see both AIC and model fit statistics
#anova(model1, model2, model3, model4)
aic_values <- AIC(model1, model2, model3, model4, model5)
print(aic_values)

# best AIC was model5

model_pea <- lmerTest::lmer(pea_yield ~ germplasmName * peaName + (1 | studyLoc), data = multi_location_data)

# Perform Type III ANOVA to test the significance of each term as a group
# significance tests for each fixed effect in your model after accounting for all other effects
anova_results <- anova(model_pea, type = 3)
anova_results
# Sum Sq (Sum of Squares): represents the amount of variance in the response variable that is explained by each predictor or interaction term in the model.Higher sums of squares indicate a larger contribution of that factor to explaining variability in the response variable.
# Mean Sq (Mean Square): sum of squares divided by the degrees of freedom for each effect.Used to calculate the F-value and indicates how much of the variance can be attributed to that effect on average.
# F-value: ratio of the mean square of the effect to the mean square of the error (residuals). A higher F-value indicates a more significant effect, suggesting that the variance explained by this effect is large relative to the residual variance.
# Pr(>F): p-value associated with the F-test for each effect. A small p-value (typically < 0.05) suggests that the effect is statistically significant, meaning it has a significant impact on the response variable after accounting for all other effects.


# Create a table of significant results
significant_summary <- broom.mixed::tidy(model_pea, effects = "fixed") %>%
  filter(p.value < 0.05)

significant_summary %>%
  select(term, estimate, std.error, statistic, p.value) %>%
  mutate(p.value = format(p.value, scientific = TRUE)) %>%
  kable(digits = 3, caption = "Significant Covariates in Linear Mixed Model for Pea Yield",
        col.names = c("Term", "Estimate", "Std. Error", "t value", "P value")) %>%
  kable_styling(full_width = FALSE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))

anova_results %>%
  select(`Sum Sq`, `Mean Sq`, NumDF, `F value`, `Pr(>F)`) %>%
  kable(digits = 5, caption = "Significant Covariates in Linear Mixed Model for Pea Yield",
        col.names = c("Sum Sq", "Mean Sq", "NumDF", "F value", "Pr(>F)")) %>%
  kable_styling(full_width = FALSE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))

rm(model1, model2, model3, model4, model5, significant_summary, aic_values, anova_results)
```

## Total Yield
```{r}
# multi-location mixed-effects model with spatial correction
# Since spatial variation may differ between locations, include location as a random effect in the model

model1 <- lmer(total_grain ~ germplasmName + peaName + oat_yield + pea_yield + (1 | studyLoc), data = multi_location_data)
model2 <- lmer(total_grain ~ germplasmName + peaName + (1 | studyLoc), data = multi_location_data)
model3 <- lmer(total_grain ~ germplasmName + peaName + oat_yield + pea_yield + (1 | studyLoc/blockNumber), data = multi_location_data)
model4 <- lmer(total_grain ~ germplasmName + peaName + (1 | studyLoc/blockNumber), data = multi_location_data)
model5 <- lmer(total_grain ~ germplasmName * peaName + (1 | studyLoc), data = multi_location_data)


# Compare models with anova to see both AIC and model fit statistics
#anova(model1, model2, model3, model4)
aic_values <- AIC(model1, model2, model3, model4, model5)
print(aic_values)

# best AIC was model5

model_total <- lmerTest::lmer(total_grain ~ germplasmName * peaName + (1 | studyLoc), data = multi_location_data)

# Perform Type III ANOVA to test the significance of each term as a group
# significance tests for each fixed effect in your model after accounting for all other effects
anova_results <- anova(model_total, type = 3)
anova_results
# Sum Sq (Sum of Squares): represents the amount of variance in the response variable that is explained by each predictor or interaction term in the model.Higher sums of squares indicate a larger contribution of that factor to explaining variability in the response variable.
# Mean Sq (Mean Square): sum of squares divided by the degrees of freedom for each effect.Used to calculate the F-value and indicates how much of the variance can be attributed to that effect on average.
# F-value: ratio of the mean square of the effect to the mean square of the error (residuals). A higher F-value indicates a more significant effect, suggesting that the variance explained by this effect is large relative to the residual variance.
# Pr(>F): p-value associated with the F-test for each effect. A small p-value (typically < 0.05) suggests that the effect is statistically significant, meaning it has a significant impact on the response variable after accounting for all other effects.


# Create a table of significant results
significant_summary <- broom.mixed::tidy(model_total, effects = "fixed") %>%
  filter(p.value < 0.05)

significant_summary %>%
  select(term, estimate, std.error, statistic, p.value) %>%
  mutate(p.value = format(p.value, scientific = TRUE)) %>%
  kable(digits = 3, caption = "Significant Covariates in Linear Mixed Model for Total Grain Yield",
        col.names = c("Term", "Estimate", "Std. Error", "t value", "P value")) %>%
  kable_styling(full_width = FALSE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))

anova_results %>%
  select(`Sum Sq`, `Mean Sq`, NumDF, `F value`, `Pr(>F)`) %>%
  kable(digits = 5, caption = "Significant Covariates in Linear Mixed Model for Total Grain Yield",
        col.names = c("Sum Sq", "Mean Sq", "NumDF", "F value", "Pr(>F)")) %>%
  kable_styling(full_width = FALSE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))

rm(model1, model2, model3, model4, model5, significant_summary, aic_values, anova_results)
```
